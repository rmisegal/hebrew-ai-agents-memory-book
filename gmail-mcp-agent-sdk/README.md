# Gmail MCP Server - SDK Version

Gmail MCP Server implementation using the **official MCP Python SDK**. This is the modern, production-ready approach described in Appendix E of the book.

## Features

- ✅ Uses official `mcp` Python SDK
- ✅ Async/await architecture
- ✅ Automatic tool registration with `@app` decorators
- ✅ UTF-8-sig encoding for Excel compatibility
- ✅ Hebrew text support
- ✅ Type-safe with proper error handling

## Prerequisites

- Python 3.10 or higher
- Google Cloud project with Gmail API enabled
- Claude CLI installed

## Setup

### 1. Install Dependencies

```bash
# Create virtual environment (recommended)
python -m venv venv

# Activate (Windows)
venv\Scripts\activate

# Activate (Linux/Mac)
source venv/bin/activate

# Install requirements
pip install -r requirements.txt
```

### 2. Configure Google OAuth

1. Go to [Google Cloud Console](https://console.cloud.google.com/)
2. Create a new project or select existing
3. Enable **Gmail API**
4. Go to "Credentials" → "Create Credentials" → "OAuth 2.0 Client ID"
5. Choose "Desktop app"
6. Download the JSON file
7. Save it as `private/credentials.json` in this directory

### 3. Run OAuth Setup

```bash
python setup_oauth.py
```

This will:
- Open your browser for Google authentication
- Request Gmail readonly access
- Save `private/token.json` for future use

## Testing the Server Directly

You can test the server works before integrating with Claude:

```bash
# Run the server
python gmail_mcp_server_sdk.py
```

The server will start in STDIO mode waiting for MCP protocol messages.

## Integrating with Claude CLI

### Configure Claude CLI

Add this to your Claude config file (`~/.config/claude/config.json` or Windows equivalent):

```json
{
  "mcpServers": {
    "gmail-extractor": {
      "command": "python",
      "args": [
        "C:/25D/GeneralLearning/gmail_ai_agent_book_and_example/gmail-mcp-agent-sdk/gmail_mcp_server_sdk.py"
      ],
      "env": {}
    }
  }
}
```

**Important:** Use absolute paths for the Python script.

### Using with Claude CLI

Start Claude and the MCP server will automatically load:

```bash
claude
```

Then you can use natural language:

```
Search my Gmail for emails with label "Research_Data" from the last 30 days
```

Or explicitly call the tool:

```
Use the gmail-extractor tool to search emails:
- label: INBOX
- start_date: 2025-09-20
- end_date: 2025-10-20
- max_results: 50
```

## Tool Available

### `search_and_export_emails`

Search Gmail by label and date range, export to CSV.

**Parameters:**
- `label` (string, optional): Gmail label (e.g., "INBOX", "Research_Data")
- `start_date` (string, optional): Start date in YYYY-MM-DD format
- `end_date` (string, optional): End date in YYYY-MM-DD format
- `max_results` (integer, optional): Maximum results, default 100

**Returns:**
JSON response with:
```json
{
  "success": true,
  "count": 15,
  "message": "Successfully exported 15 emails",
  "output_file": "csv/INBOX_20251020_143022.csv",
  "query": "label:INBOX after:2025-09-20 before:2025-10-20"
}
```

**CSV Output:**
- Location: `csv/` directory
- Encoding: UTF-8 with BOM (Excel compatible)
- Columns: Date, From, Subject
- Filename format: `{label}_{timestamp}.csv`

## Comparison: SDK vs Manual

| Aspect | Manual (old) | SDK (this) |
|--------|-------------|------------|
| Lines of code | ~150 | ~230 (with docs) |
| Setup complexity | High | Low |
| Protocol handling | Manual | Automatic |
| Tool registration | JSON dict | Decorator |
| Error handling | Manual | Built-in |
| Maintenance | Complex | Simple |

## Troubleshooting

### "Token file not found"
Run `python setup_oauth.py` first.

### "Permission denied"
Check that `private/token.json` exists and is readable.

### "ModuleNotFoundError: mcp"
Install requirements: `pip install -r requirements.txt`

### "Gmail API not enabled"
Enable Gmail API in Google Cloud Console.

### Claude doesn't see the tool
- Check config.json syntax (valid JSON)
- Use absolute paths
- Restart Claude CLI

## Directory Structure

```
gmail-mcp-agent-sdk/
├── gmail_mcp_server_sdk.py  # Main MCP server
├── setup_oauth.py            # OAuth setup script
├── requirements.txt          # Python dependencies
├── README.md                 # This file
├── private/                  # OAuth credentials (gitignored)
│   ├── credentials.json      # From Google Cloud (you provide)
│   └── token.json            # Generated by setup_oauth.py
└── csv/                      # Output directory for CSV files
    └── *.csv                 # Generated email exports
```

## Security Notes

- Never commit `private/` directory to git
- Keep `credentials.json` and `token.json` secure
- Token has readonly Gmail access only
- CSV files may contain sensitive email data

## License

See LICENSE file in parent directory.
