\hebrewsection{נספח א: \en{\texttt{gmail\_mcp\_server.py}}}

\textbf{ייבוא ספריות והגדרת חיבור:}

\begin{pythonbox}
import os, csv
from google.oauth2.credentials import Credentials
from googleapiclient.discovery import build

creds = Credentials.from_authorized_user_file(
    'private/token.json',
    scopes=['https://www.googleapis.com/auth/gmail.readonly']
)
service = build('gmail', 'v1', credentials=creds)
\end{pythonbox}

\textbf{פונקציית חיפוש והבניית שאילתא:}

\begin{pythonbox}
def search_and_export_emails(label=None, start_date=None,
                              end_date=None, max_results=100):
    query = ""
    if label:
        query += f"label:{label} "
    if start_date:
        query += f"after:{start_date} "
    if end_date:
        query += f"before:{end_date} "

    results = service.users().messages().list(
        userId='me', q=query.strip(),
        maxResults=max_results
    ).execute()
    return results.get('messages', [])
\end{pythonbox}

\textbf{ייצוא ל\en{-CSV} עם תמיכה ב\en{-Unicode}:}

\begin{pythonbox}
def export_to_csv(messages, output_file):
    os.makedirs(os.path.dirname(output_file), exist_ok=True)
    with open(output_file, 'w', newline='',
              encoding='utf-8-sig') as csvfile:
        writer = csv.writer(csvfile)
        writer.writerow(["Date", "From", "Subject"])

        for msg in messages:
            msg_data = service.users().messages().get(
                userId='me', id=msg['id']
            ).execute()

            headers = msg_data.get('payload', {}).get('headers', [])
            date = next((h['value'] for h in headers if h['name'] == 'Date'), '')
            from_addr = next((h['value'] for h in headers if h['name'] == 'From'), '')
            subject = next((h['value'] for h in headers if h['name'] == 'Subject'), '')

            writer.writerow([date, from_addr, subject])
\end{pythonbox}
